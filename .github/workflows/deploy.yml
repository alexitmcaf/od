name: CI/CD for Odoo with Custom PostgreSQL

on:
  push:
    branches:
      - main

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v2

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Start Docker Compose
        run: docker-compose -f docker-compose.test.yml up -d --build

      - name: List Running Containers
        run: docker ps -a

      - name: Wait for PostgreSQL
        run: |
          echo "Waiting for PostgreSQL to be ready..."
          for i in {1..30}; do  # Increase retries to 30
            docker exec $(docker ps -q -f name=db) pg_isready -U odoo && break
            echo "PostgreSQL not ready yet..."
            sleep 10
          done
          docker exec $(docker ps -q -f name=db) pg_isready -U odoo || exit 1

      - name: Create Odoo Database if Not Exists
        run: |
          docker exec $(docker ps -q -f name=db) psql -U odoo -d postgres -c "SELECT 1 FROM pg_database WHERE datname='odoo16';" | grep -q 1 || \
          docker exec $(docker ps -q -f name=db) psql -U odoo -d postgres -c "CREATE DATABASE odoo16;"

      - name: Debug PostgreSQL
        run: |
          echo "Listing PostgreSQL databases..."
          docker exec $(docker ps -q -f name=db) psql -U odoo -d postgres -c "\l"

      - name: Test Networking Between Services
        run: |
          echo "Testing network connectivity between Odoo and PostgreSQL..."
          docker exec $(docker ps -q -f name=odoo16) ping -c 4 db

      - name: Test PostgreSQL Connection from Odoo
        run: |
          echo "Testing PostgreSQL connection from Odoo..."
          docker exec $(docker ps -q -f name=odoo16) psql -U odoo -h db -d odoo16 -c "\l"

      - name: Test Odoo Service
        run: |
          echo "Waiting for Odoo to be ready..."
          for i in {1..60}; do  # Increase retries to 60
            if curl -f http://localhost:10016; then
              echo "Odoo is ready!"
              break
            fi
            echo "Retrying in 10 seconds..."
            sleep 10
          done

          # Fail the build if Odoo is still not ready
          if ! curl -f http://localhost:10016; then
            echo "Odoo failed to start or connect to PostgreSQL. Check logs for details."
            exit 1
          fi

      - name: Debug Odoo Logs
        run: |
          echo "Fetching Odoo logs..."
          docker logs $(docker ps -q -f name=odoo16)

      - name: Debug Container Networking
        run: |
          echo "Inspecting Odoo container networking..."
          docker inspect $(docker ps -q -f name=odoo16)

      - name: Stop Docker Compose
        run: docker-compose -f docker-compose.test.yml down
